<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <div class="funnel-con">
        <div class="funnel-top">
            <table class="funnel-table-bg" cellpadding="0" cellspacing="0">
                <tbody>
                <tr>

                    <td class="td-line"></td>
                    <td class="td-line"></td>
                    <td class="td-line"></td>
                    <td class="td-line"></td>
                    <td class="td-line"></td>
                    <td class="td-line"></td>
                    <td class="td-line"></td>
                </tr>
                <tr>

                    <td class="td-line"></td>
                    <td class="td-line"></td>
                    <td class="td-line"></td>
                    <td class="td-line"></td>
                    <td class="td-line"></td>
                    <td class="td-line"></td>
                    <td class="td-line"></td>
                </tr>
                <tr>

                    <td class="td-line"></td>
                    <td class="td-line"></td>
                    <td class="td-line"></td>
                    <td class="td-line"></td>
                    <td class="td-line"></td>
                    <td class="td-line"></td>
                    <td class="td-line"></td>
                </tr>
                <tr>

                    <td class="td-line"></td>
                    <td class="td-line"></td>
                    <td class="td-line"></td>
                    <td class="td-line"></td>
                    <td class="td-line"></td>
                    <td class="td-line"></td>
                    <td class="td-line"></td>
                </tr>
                <tr>

                    <td class="td-line"></td>
                    <td class="td-line"></td>
                    <td class="td-line"></td>
                    <td class="td-line"></td>
                    <td class="td-line"></td>
                    <td class="td-line"></td>
                    <td class="td-line"></td>
                </tr>
                <tr>

                    <td class="td-line"></td>
                    <td class="td-line"></td>
                    <td class="td-line"></td>
                    <td class="td-line"></td>
                    <td class="td-line"></td>
                    <td class="td-line"></td>
                    <td class="td-line"></td>
                </tr>
                </tbody>
            </table>
            <div class="stage1">
                <div class="stage1-top title-top">
                    <div class="title-con">
                        <div class="title-content">全部访问</div>
                        <div class="title-bottom success-num">0</div>
                    </div>
                </div>
                <div class="stage-primary column"></div>
                <div class="middle-shadow" style="left: 70px;">
                    <div class="bg-top triangle" ></div>
                    <div class="bg-bottom bottom-shadow"></div>
                </div>
                <div class="percentage-bg" style="left: 70px;">
                    <div class="triangle-left">
                        <div class="triangle-con">8.54%</div>
                    </div>
                    <div class="triangle-right"></div>
                </div>
            </div>
            <div class="stage2">
                <div class="stage2-top title-top">
                    <div class="title-con">
                        <div class="title-content">有效访问</div>
                        <div class="title-bottom success-num">7</div>
                    </div>
                </div>
                <div class="stage-primary column"></div>
                <div class="stage-delta middle-shadow" style="left: 260px;">
                    <div class="bg-top triangle" ></div>
                    <div class="bg-bottom bottom-shadow"></div>
                </div>
                <div class="stage3-delta-arrow percentage-bg" style="left: 260px;">
                    <div class="triangle-left">
                        <div class="triangle-con">57.14%</div>
                    </div>
                    <div class="triangle-right"></div>
                </div>
            </div>
            <div class="stage3">
                <div class="stage3-top title-top">
                    <div class="title-con">
                        <div class="title-content">详情页</div>
                        <div class="title-bottom success-num">4 </div>
                    </div>
                </div>
                <div class="addCon" style="border-bottom: 0px;"></div>
                <div class="stage-primary column"></div>
                <div class="stage-delta middle-shadow" style="left: 450px;">
                    <div class="bg-top triangle" ></div>
                    <div class="bg-bottom bottom-shadow"></div>
                </div>
                <div class="stage4-delta-arrow percentage-bg" style="left: 450px;">
                    <div class="triangle-left">
                        <div class="triangle-con">50%</div>
                    </div>
                    <div class="triangle-right"></div>
                </div>
            </div>
            <div class="stage4">
                <div class="stage4-top title-top">
                    <div class="title-con">
                        <div class="title-content">加入购物车</div>
                        <div class="title-bottom success-num">2</div>
                    </div>
                </div>
                <div class="addCon" style="border-bottom: 0px;"></div>
                <div id="added"></div>
                <div class="stage-primary column"></div>
                <div class="stage-delta middle-shadow" style="left: 640px;">
                    <div class="bg-top triangle" ></div>
                    <div class="bg-bottom bottom-shadow"></div>
                </div>
                <div class="stage5-delta-arrow percentage-bg" style="left: 640px;">
                    <div class="triangle-left">
                        <div class="triangle-con">100%</div>
                    </div>
                    <div class="triangle-right"></div>
                </div>
            </div>
            <div class="stage5">
                <div class="stage-top title-top">
                    <div class="title-con">
                        <div class="title-content">购物车页</div>
                        <div class="title-bottom success-num">6</div>
                    </div>
                </div>

                <div class="stage-primary column"></div>
                <div class="stage-delta middle-shadow" style="left: 830px;">
                    <div class="bg-top triangle" ></div>
                    <div class="bg-bottom bottom-shadow"></div>
                </div>
                <div class="stage5-delta-arrow percentage-bg" style="left: 830px;">
                    <div class="triangle-left">
                        <div class="triangle-con">100%</div>
                    </div>
                    <div class="triangle-right"></div>
                </div>
            </div>
            <div class="stage6">
                <div class="stage6-top title-top">
                    <div class="title-con">
                        <div class="title-content">订单填写页</div>
                        <div class="title-bottom success-num"></div>
                    </div>
                </div>

                <div class="stage-primary column"></div>
                <div class="stage-delta middle-shadow" style="left: 1020px;">
                    <div class="bg-top triangle"></div>
                    <div class="bg-bottom bottom-shadow"></div>
                </div>
                <div class="stage5-delta-arrow percentage-bg" style="left: 1020px;">
                    <div class="triangle-left">
                        <div class="triangle-con">100%</div>
                    </div>
                    <div class="triangle-right"></div>
                </div>
            </div>
            <div class="stage7">
                <div class="stage7-top title-top">
                    <div class="title-con">
                        <div class="title-content">订单成功页</div>
                        <div class="title-bottom success-num"></div>
                    </div>
                </div>
                <div class="stage-primary column"></div>
            </div>
        </div>
        <div class="funne-dropoff">
            <div class="stage-dropoff">
                <div class="dropoff-arrow">
                    <div class="arrow-t"></div>
                    <div class="arrow-b"></div>
                </div>
                <div class="title-con">
                    <div class="title-content">跳出访问</div>
                    <div class="title-bottom fail-num">0</div>
                </div>
            </div>
            <div class="stage-dropoff">
                <div class="dropoff-arrow">
                    <div class="arrow-t"></div>
                    <div class="arrow-b"></div>
                </div>
                <div class="title-con">
                    <div class="title-content">未访问详情页</div>
                    <div class="title-bottom fail-num">0</div>
                </div>
            </div>
            <div class="stage-dropoff">
                <div class="dropoff-arrow">
                    <div class="arrow-t"></div>
                    <div class="arrow-b"></div>
                </div>
                <div class="title-con">
                    <div class="title-content">未加入购物车</div>
                    <div class="title-bottom fail-num">0</div>
                </div>
            </div>
            <div class="stage-dropoff">
                <div class="dropoff-arrow">
                    <div class="arrow-t"></div>
                    <div class="arrow-b"></div>
                </div>
                <div class="title-con">
                    <div class="title-content"> 未达到购物车页</div>
                    <div class="title-bottom fail-num">0</div>
                </div>
            </div>
            <div class="stage-dropoff">
                <div class="dropoff-arrow">
                    <div class="arrow-t"></div>
                    <div class="arrow-b"></div>
                </div>
                <div class="title-con">
                    <div class="title-content">未去往订单填写页</div>
                    <div class="title-bottom fail-num">0</div>
                </div>
            </div>
            <div class="stage-dropoff">
                <div class="dropoff-arrow">
                    <div class="arrow-t"></div>
                    <div class="arrow-b"></div>
                </div>
                <div class="title-con">
                    <div class="title-content">未达到订单成功页</div>
                    <div class="title-bottom fail-num">0</div>
                </div>
            </div>
        </div>
    </div>
</body>
<script src="jquery-1.7.2.min.js"></script>
<script src="fun.js" type="text/javascript"></script>
<script type="text/javascript">
    var position = ["0","190px","380px","570px","760px","950px","1140px"];
   $(function () {
       $('.column').each(function (index, item) {
           $(item).css('left',position[index]);
       });
       $('.stage-dropoff').each(function (index, item) {
           $(item).css('left',position[index])
       });
       $('.title-top').each(function (index, item) {
           $(item).css('left',position[index])
       });
       $.post("data2.json",function (da) {
           //拿到total数组数据的第一个json对象
           var initData= da["total"][0];
           //定义下部分（Down）的数据
           var data=utils.drawData(initData,"down");
           //定义下部分（Up）的数据
           var dataUp=utils.drawData(initData,"up");
           //拿到第一部分的所有数据，放入list
           var list=[];//Down 部分
           var listData=[];
           for (var k in data){
               list.push(data[k])
           }
           for (var k in dataUp){// up部分
               listData.push(dataUp[k])
           }
           var totalNum = utils.addList(list,listData);
           debugger
            //定义最大高度，即tr高度乘以个数
           var maxHeight=$(".funnel-table-bg tr:eq(1)").find(".td-line").height()*5;
           //获取list中最大的数
           var max = utils.maxValue(list[0]);
           debugger
           //获取每部分数据对应的高度
           var calcHeightList = utils.calcRate(max,maxHeight,list);
           var calcHeightListUp = utils.calcRate(max,maxHeight,listData);
           //设置对应css的属性
           $(".stage-primary").each(function (index, item) {
              $(item).css("height",calcHeightList[index])
          });
           var lineDiffList = utils.lineDiff(calcHeightList);//相邻之差
//           var newCalcHeightList = calcHeightList.slice(1,calcHeightList.length);


           $(".bg-top").each(function (index, item) {
               var recalc = calcHeightListUp[index]+lineDiffList[index];
               var judge = calcHeightList[index]+calcHeightListUp[index]-calcHeightList[index+1]+1;
                 if(parseInt(lineDiffList[index]) >0){  //正三角形
                  $(item).css("border-bottom-width",recalc+1);
                  $(item).css("bottom",calcHeightList[index+1]);
                  $(item).siblings('.bg-bottom').css("height",calcHeightList[index+1]);
//                  if(calcHeightListUp[index] !=0){
//                      $(item).css("border-bottom-width",(calcHeightListUp[index]+parseInt($(item).css("border-bottom-width"))+1)+"px");
//                  }
              }else if(judge>0){//正三角形
                     $(item).css("border-bottom-width",judge);//前上下和-后下
                     $(item).css("bottom",calcHeightList[index+1]);
                     $(item).siblings('.bg-bottom').css("height",calcHeightList[index+1]);
              }else {
                     //三角形反过来
                     $(item).css("border-bottom-width",-recalc);
                     $(item).siblings('.bg-bottom').css("height",calcHeightList[index]+calcHeightListUp[index]);
                     $(item).css({
                         "bottom":calcHeightList[index]+calcHeightListUp[index],
                         "border-right": "0",
                         "border-left-width":"120px",
                         "border-left-style": "solid",
                         "border-left-color":"transparent"
                     });
                 }

          });
            //设置up部分柱形图
           var str = "";
           for(var i =0;i<calcHeightListUp.length;i++){
               //计算叠加部分（第二部分，Up部分）的索引，
               var height = $($(".stage-primary")[i]).css("height");
               height = height ==0?"1px":height;
               str+='<div class="addCon" style="height: '+calcHeightListUp[i]+'px; left: '+position[i]+'; bottom: '+height+';"></div>';
           }
           $("#added").html(str);

           $('.success-num').each(function (index, item) {
               var amended = utils.toThousands(totalNum[index]);
               $(item).html(amended);
           });
             var number = utils.decreaseList(totalNum,list);
            $('.fail-num').each(function (index, item) {
                 var amended = utils.toThousands(number[index]);
                 $(item).html(amended);
            });
           var divideNum = utils.divideList(totalNum,list);
            $('.triangle-con').each(function (index, item) {
                var curPercentage = divideNum[index];
                curPercentage = curPercentage == '--' ? curPercentage:curPercentage+'%';
                $(item).html(curPercentage);
                var addClass = utils.getClass(divideNum[index]);
                $(item).parent('.triangle-left').attr('class','triangle-left '+addClass);
                $(item).parent('.triangle-left').siblings('.triangle-right').attr('class','triangle-right '+(addClass+'1'));
            });




      })

   });
</script>
</html>